---
title: "Summary Analysis of Remote Emission Sensing Data"
author: CARES project
date: "`r paste('Date:', format(Sys.time(), '%d %B, %Y'))`"
output:
  bookdown::html_document2: 
    theme: flatly
    toc: yes
    toc_float:
      collapsed: false
#bibliography: DCC-refs.bib
link-citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(openCARES)
library(tidyverse)
library(gt)
library(DT)
library(plotly)
library(RColorBrewer)
theme_set(theme_minimal())
```

<center>

![](CARES_logo.jpeg){width="300"}

</center>

# Introduction

## Background

This document provides a detailed summary of remote emission sensing (RES) data as part of the [CARES](https://cares-project.eu) project.

## Aims

The analysis of RES data can be challenging given the complexity and typical size of the data collected during experimental campaigns. Even within the small community of researchers and practitioners that typically conduct experiments, there is a wide variation in the analysis approaches used and their consistency. With that in mind, this document has the following aims:

1.  To provide a reliable and automated way of presenting key summary data and plots from RES campaigns.

2.  Adopt 'modern' data analysis approaches using [R Statistical Software](https://www.r-project.org) and automated report production using [Rmarkdown](https://rmarkdown.rstudio.com).

3.  These approaches offer many advantages over traditional ways of analysing data and presenting it. For example, allowing for detailed data to be presented in a compact way that can easily be filtered by the user, and the use of 'tabs' to better structure the output.

4.  To present common numerical and graphical outputs that help to interpret data from RES campaigns.

The analysis software and the underlying code that produced this document are part of a R package called `openCARES`. The package is available as a GitHub repository and all code is managed under a version control system. The approach means that all changes are recorded and that members of the CARES team can work collaboratively to develop the analysis capabilities over time.

Currently, this document is based on early data collected as part of the CONOX project consisting of about 100,000 measurements, which is similar to the aims of the City Demonstrations as part of the CARES project.

# Numerical summaries

## Vehicle numbers

An example of a way in which to present vehicles samples is shown in Figure \@ref(fig:type-fuel).

```{r type-fuel,fig.cap='Numbers of vehicle by main vehicle and fuel type. Click on the key to select specific segments.'}
out <- conox %>% 
  filter(FuelType != "NO DATA", VehicleCategory != "No data") %>% 
  mutate(label = paste0(VehicleCategory, " (", FuelType, ")"),
         label = fct_lump_prop(label, prop = 0.01)) %>% 
  count(label)

fig <- out %>% 
  plot_ly(labels = ~label, values = ~n) %>% 
  add_pie(hole = 0.6) %>% 
  layout(title = "Vehicle type summary",  showlegend = TRUE)
fig
```

## Measurement conditions {.tabset}

### All data

```{r}
conox %>% 
  filter(SAFlag != "X",
         VSPStatus != "X"
       ) %>% 
  summarise(`Speed (kph)` = mean(SpeedKPH, na.rm = TRUE),
            VSP = mean(VSP, na.rm = TRUE),
            n = n()) %>% 
  gt() %>% 
   fmt_number(
    columns = everything(),
    suffixing = TRUE
  ) %>% 
  tab_options(table.align = "left")
```

```{r fig.width=5,fig.height=4.5,fig.cap='Density plot of all VSP data.'}
ggplot(conox, aes(VSP)) + 
  geom_density(fill = "dodgerblue") + 
  xlim(-10, 30)
```

### By site

```{r}
conox %>% 
  filter(SAFlag != "X",
         VSPStatus != "X"
       ) %>% 
  group_by(Site) %>% 
  summarise(`Speed (kph)` = mean(SpeedKPH, na.rm = TRUE),
            VSP = mean(VSP, na.rm = TRUE),
            n = n()) %>% 
  gt() %>% 
   fmt_number(
    columns = 2:4,
    suffixing = TRUE
  ) %>% 
  tab_options(table.align = "left")
```

```{r fig.width=5,fig.height=4.5,fig.cap='Density plot of all VSP data, split by site.'}
ggplot(conox, aes(VSP, fill = Site, colour = Site)) + 
  geom_density() + 
  facet_wrap(vars(Site)) +
  theme(legend.position = "none") +
  xlim(-10, 30)
```

## Emission summaries {.tabset}

All data presented as fuel-specific emission factors i.e. g pollutant per kg fuel.

### All data

```{r}
conox %>% 
  filter(
       ) %>% 
  summarise(NOx = mean(NOx_gpkg, na.rm = TRUE),
            NO = mean(NO_gpkg, na.rm = TRUE),
            CO = mean(CO_gpkg, na.rm = TRUE),
            HC = mean(HC_gpkg, na.rm = TRUE),
            UV_smoke = mean(UV_Smoke_gpkg, na.rm = TRUE),
            n = n()) %>% 
  gt() %>% 
   fmt_number(
    columns = everything(),
    suffixing = TRUE
  ) %>% 
  tab_options(table.align = "left")
```

### By fuel

```{r}
conox %>% 
  filter(
       ) %>% 
  group_by(FuelType) %>% 
  summarise(NOx = mean(NOx_gpkg, na.rm = TRUE),
            NO = mean(NO_gpkg, na.rm = TRUE),
            CO = mean(CO_gpkg, na.rm = TRUE),
            HC = mean(HC_gpkg, na.rm = TRUE),
            UV_smoke = mean(UV_Smoke_gpkg, na.rm = TRUE),
            n = n()) %>% 
  gt() %>% 
   fmt_number(
    columns = 2:7,
    suffixing = TRUE
  ) %>% 
  tab_options(table.align = "left")
```

## Detailed pollutant summaries {.tabset}

### NO~x~

The table below shows the mean and 95% confidence interval in the mean is given.

```{r}
conox %>% 
    filter(FuelType != "NO DATA",
    ) %>% 
    group_by(MODEL_NAME, FuelType, EuroStandard) %>% 
    summarise(bootMeanDF(NOx_gpkg)) %>% 
  mutate(mean = round(mean, 2),
         min = round(min, 2),
         max = round(max, 2)) %>% 
  datatable(filter = "top",
            extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))
  )
```

### CO

The table below shows the mean and 95% confidence interval in the mean is given.

```{r}
conox %>% 
    filter(FuelType != "NO DATA",
    ) %>% 
    group_by(MODEL_NAME, FuelType, EuroStandard) %>% 
    summarise(bootMeanDF(CO_gpkg)) %>% 
  mutate(mean = round(mean, 2),
         min = round(min, 2),
         max = round(max, 2)) %>% 
  datatable(filter = "top",
            extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))
    )
```

### HC

The table below shows the mean and 95% confidence interval in the mean is given.

```{r}
conox %>% 
    filter(FuelType != "NO DATA",
    ) %>% 
    group_by(MODEL_NAME, FuelType, EuroStandard) %>% 
    summarise(bootMeanDF(HC_gpkg)) %>% 
  mutate(mean = round(mean, 2),
         min = round(min, 2),
         max = round(max, 2)) %>% 
  datatable(filter = "top",
            extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))
    )
```

### UV smoke

The table below shows the mean and 95% confidence interval in the mean is given.

```{r}
conox %>% 
    filter(FuelType != "NO DATA",
    ) %>% 
    group_by(MODEL_NAME, FuelType, EuroStandard) %>% 
    summarise(bootMeanDF(UV_Smoke_gpkg)) %>% 
  mutate(mean = round(mean, 2),
         min = round(min, 2),
         max = round(max, 2)) %>% 
  datatable(filter = "top",
            extensions = 'Buttons', options = list(
    dom = 'Bfrtip',
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))
    )
```

### 

## Vehicle manufacturers {.tabset}

### PC gasoline

```{r}
manu <- conox %>%
  filter(FuelType == "PETROL", VehicleCategory == "PC") %>%
  select(VehicleMake, contains("gpkg")) %>%
  drop_na(VehicleMake) %>% 
  mutate(Manufacturer = fct_lump_prop(VehicleMake, prop = 0.01)) %>%
  select(-starts_with("UV")) %>%
  group_by(Manufacturer) %>%
  summarise(across(contains("gpkg"), mean, na.rm = T),
            n = n()) %>%
  arrange(CO_gpkg) %>%
  mutate(n = n / sum(n),
         w = cumsum(n),
         wm = w - n, 
         wt = wm + (w - wm)/2) %>%
  select(-starts_with(c("HC", "NO", "NO2", "NOx", "NH3")))

mycolours <- colorRampPalette(brewer.pal(12, "Paired"))(25)

ggplot(manu, aes(ymin = 0)) + 
  geom_rect(aes(xmin = wm, xmax = w, ymax = CO_gpkg, fill = Manufacturer), 
            color = "white") +
  geom_text(aes(x = wt, y = CO_gpkg, label = Manufacturer), 
            color = "black", angle = 90, nudge_y = 3) +
  ggpubr::grids() + 
  scale_x_continuous(labels = scales::label_percent()) + 
  scale_y_continuous(expand = expansion(mult = c(0,.10))) + 
  theme(legend.position = "none") + 
  labs(x = "Fleet share", y = openair::quickText("Fuel-specific CO (g/kg)")) + 
  scale_fill_manual(values = mycolours)
```
